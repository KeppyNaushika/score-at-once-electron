Electronデスクトップアプリケーション「一括採点」の設計と実装に関する包括的なプロンプト
あなたは、Python Tkinterベースの既存の「一括採点」スクリプトから、より高機能で使いやすく、複数教員での協調作業が可能なElectronデスクトップアプリケーションを開発します。

アプリケーションの概要と目的
本アプリケーションは、試験の答案画像をデジタル採点し、その結果をExcelファイル、PDFファイルとして出力することを目的とします。特に、複数教員による並行採点と、その後の結果統合を効率的に行えるように設計します。

ターゲットプラットフォームと技術スタック
ターゲットプラットフォーム: Windows, macOS, Linux (Electronがサポートする主要なOS)
フロントエンドフレームワーク: React (TypeScriptを使用)
バックエンド (Electronメインプロセス): Node.js (TypeScriptを使用)
データベース: Prisma ORM と SQLite (データベースファイルは共有フォルダに配置)
画像処理: sharp (高速な画像操作全般), opencv.js (高度な画像認識・処理)
Excel出力: exceljs (リッチなExcelファイルの生成)
PDF出力: pdf-lib (採点済みPDFの生成)
OCR (限定的): Tesseract.js (将来的な検討として、学籍番号や氏名など、定型的な手書き数字/英数字認識に限定して活用する可能性を考慮するが、手書き文字認識の精度はほとんど期待しないことを前提とする)

コア機能の要件 (既存機能の再構築と強化)
答案画像の読み込みと管理:
スキャンされた答案画像ファイル（PNG形式を想定）を読み込み、アプリケーション内で管理する。
読み込んだ画像は、データベースファイルと同じ共有フォルダ内の指定サブフォルダに保存し、DB内のパスは相対パスで記録する。
解答用紙解答枠の定義:
採点対象となる解答用紙の採点枠（解答欄、氏名欄、学籍番号欄、目印など）をGUI上で定義し、解答枠として保存・管理する機能。
各設問の解答領域の座標、サイズ、期待される解答形式（マークシート、記述式など）を設定可能にする。
画像前処理:
読み込んだ答案画像に対して、自動で傾き補正、台形補正、適切な二値化処理を行う。これらの処理はopencv.jsを内部で利用し、外部ツールへの依存をなくす。
補足: opencv.jsは画像の位置合わせや画質調整に非常に有効だが、手書き文字の認識（OCR）はほとんど期待できない点に留意する。
必要に応じて、ユーザーが手動で微調整できるインターフェースも提供する。
採点ロジック:
定義された解答枠と画像認識（opencv.js）に基づき、マークシートの塗りつぶし状況や、記述欄の特定パターン認識により、自動採点を行う。
手書き文字の認識（OCR）は、現在のバージョンでは主要な機能として期待せず、手動での入力・確認を前提とする。
設問ごとの配点設定に対応する。
部分点制度に対応できる柔軟な採点ロジックを考慮する。
採点結果の表示と編集:
採点された答案画像と、その結果（得点、正誤、検出された回答）を重ねてGUI上で表示する。
検出された回答が手書き文字の場合、OCRの結果が不正確である可能性があるため、手動で編集・訂正できるインターフェースを強く提供する。
採点結果を手動で修正・調整できる機能（点数変更、正誤判定の切り替えなど）。
各設問にコメントを付与できる機能。

「リッチ化」の具体的な要件と重要機能
モダンなUI/UX:
ElectronのReactフロントエンドを活用し、現代的なデザインと直感的な操作性を提供する。
プログレスバーや視覚的フィードバックを多用し、処理の進捗を分かりやすく表示する。
エラーや警告は、ユーザーの操作を中断しない形で通知する（例: スナックバー、通知エリア）。
画像表示エリアでのズーム・パン機能。
ドラッグ＆ドロップによる画像ファイルの読み込みや、採点領域の直感的な定義（マウス操作での範囲選択）。
複数教員による同時採点と統合（最重要）:
データの共有: 共有フォルダ上の単一のSQLiteデータベースファイルに、各教員のElectronアプリが直接アクセスする形式を想定する。
教員アカウント管理: Userモデルを導入し、教員は各自のアカウントでログインして採点を行う。roleフィールド（"teacher", "admin"など）で権限を管理する。
各採点者ごとの独立した記録:
採点時には、統合処理は行わない。 各教員が自分のPCで採点した結果は、QuestionScoreテーブル内に、その教員のID (scoredByUserId) とともに独立したレコードとして保存される。
これにより、同じ答案の同じ設問に対しても、複数の教員による採点結果が並行して存在し、後で比較・統合できるようになる。
楽観的ロックの適用: QuestionScore や AnswerSheet のような、複数の教員によって同時に更新される可能性のあるレコードには、updatedAt と version (または scoreVersion) フィールドを導入し、以下のロジックで競合を検出・解決する。
更新時には、DBのレコードバージョンが、読み込んだ時点のバージョンと一致するかを確認する。
不一致の場合、他の教員が既に更新した（または最終決定した）ことを意味するため、更新を拒否し、ユーザーに警告を表示する。警告時には、最新のDBデータを再読み込みし、UIに表示（ユーザーの変更は破棄される）するよう促す。
必要であれば、ユーザーが強制的に上書きを選択できるオプションも検討（ただし慎重に）。
UIでの自動・手動リフレッシュ:
アプリケーションは、定期的に（例: 数秒ごと）現在表示している答案シートのデータが共有DB上で更新されていないか（updatedAtの比較）を監視する。
更新が検出された場合、ユーザーに「この答案には新しい採点情報があります。画面を更新しますか？」のような通知を出し、最新データを取得するよう促す。
「最新データに更新」ボタンなど、手動でのリフレッシュ機能も提供。
採点結果の比較と最終決定UI (統合フェーズ / または個別採点画面内での「最終決定」操作):
各教員が自分のPCで採点する際、または最終決定を行う際、QuestionScoreテーブル内に存在する、その答案・設問に対する全ての採点者からの提案（status = "proposed"）を表示・比較できるUIを実装する。
**「採点結果が同じであれば自動で最終決定」**というルールを導入する。この場合、いずれかの提案レコードのstatusを"final"に更新し、scoredByUserIdはその最終決定を行った教員のIDを記録する。
採点結果が異なる場合、またはコメントなどで相違がある場合は、GUI上で各教員の採点結果を確認し、最終的なスコアや正誤、コメントを手動で選択または入力し決定できるインターフェースを実装する。
この最終決定が行われたQuestionScoreのstatusを"final"に更新します。この際、unique_final_scoreデータベース制約により、一つの設問に複数の"final"なQuestionScoreが作成されないことが保証されます。 アプリケーションロジックで、既に"final"なレコードが存在する場合、それを更新する形で最終決定を変更できるように実装してください。その際、誰がいつ最終決定を更新したかを記録するようにしてください。
最終決定されたQuestionScoreの情報に基づいてAnswerSheetのtotalScoreやScoreRecordを更新する。
設定のGUI管理:
config.jsonの内容をGUI上で直感的に編集・保存・管理できる専用の設定画面を提供する。
画像前処理のパラメータ、デフォルトの出力先、フォント設定などを調整可能にする。

アプリケーション利用手順とUI/UXの詳細 (新規追加・強化)
本アプリの主要な利用手順と、それに伴う画面表示・操作について説明します。

ログイン画面:

表示内容: アプリケーションロゴ、ユーザー名/パスワード入力欄、ログインボタン、「新規アカウント作成」リンク。
操作: ユーザー名とパスワードを入力しログイン。
メインダッシュボード画面:

表示内容: 上部ナビゲーションバー（ホーム、プロジェクト管理、答案採点、採点結果、設定、ユーザー情報）、中央エリアに「あなたの採点状況」「要対応タスク」「最近の活動」などのカード、主要な操作へのショートカットボタン（例: 「新しいプロジェクトを作成」「答案を読み込む」）。
操作: 各カードやナビゲーションをクリックして目的の機能へ遷移。
生徒情報と学級の登録・管理:

アプリを最初に使う際、または新規年度開始時などに実施。
UI: 「生徒管理」または「ユーザー管理」のような専用画面。
操作:
Excelファイル形式の生徒名簿（学籍番号、氏名、学級などを含む）をインポートする機能を提供。
インポートされた生徒情報が自動的にデータベースに保存され、学級がClassモデルとしてリレーションされる。
学級情報の新規作成、編集、生徒の学級への割り当て変更などもGUI上で可能にする。
これにより、プロジェクト作成時に生徒情報を再登録する手間を省く。
プロジェクト作成:

UI: 「プロジェクト管理」画面内の「新しいプロジェクトを作成」フォーム。
操作:
プロジェクト名、日付、教科（任意）を登録。
採点者の選択: 現在ログインしている教員が自動的に追加される。他の教員（既にUserとして登録されている教員）を検索・選択して、そのプロジェクトの採点者として追加できる。追加された教員は、「全てのプロジェクト」一覧からそのプロジェクトを選択して、採点に参加することが可能。
模範解答の読み込み:
模範解答の画像ファイルを読み込む機能。
複数ページ対応: プロジェクトが複数のページにわたる答案を含む場合に対応するため、複数の画像ファイル（例: \_P1.png, \_P2.png）をまとめて読み込み、データベースで関連付けて管理できるスキーマとUIを提供する。（`MasterImageManager` コンポーネントで対応済み）
解答枠の定義:
読み込んだ模範解答画像上で、GUIを介して解答枠を定義。
操作:
GUI上でエリアの種別（設問、氏名など）を選択し、追加ボタンでデフォルトサイズのエリアを配置。
配置されたエリアは、プロパティパネルで座標（X, Y）、サイズ（幅, 高さ）を数値（画像全体に対する割合）で調整可能。
（将来的には、画像上での直接的なドラッグ操作による描画・リサイズ機能の導入を検討）
設定項目:
各エリアに以下の情報を設定可能:
種類 (`AreaType`): `QUESTION_ANSWER`, `STUDENT_NAME`, `STUDENT_ID`, `TOTAL_SCORE`, `SUBTOTAL_SCORE`, `MARK`, `COMMENT`, `OTHER`。
ラベル: エリアの識別名。
設問番号 (`questionNumber`): `QUESTION_ANSWER` の場合に設定。
配点 (`points`): `QUESTION_ANSWER` の場合に設定。
集計対象の設問番号 (`sourceQuestionNumbersJson`): `SUBTOTAL_SCORE`, `TOTAL_SCORE` の場合に、集計元となる設問番号のJSON配列（例: `["1", "2a", "3"]`）を設定。
表示場所の指定: 解答枠自体だけでなく、氏名欄、生徒番号欄、小計点、合計点の表示場所も設定できる。これらは `AreaType` と `label` で区別される。
複数の小計点/合計点表示: ページごと、大問ごと、単元ごと、観点別など、ユーザーが自由に重複して小計点や合計点が表示される領域を定義できる。これらの集計条件も同時に設定可能にする。（`LayoutRegion` の `type` と `sourceQuestionNumbersJson` で対応）
解答枠自動認識機能:
「解答枠を自動検出」ボタンを提供。
ボタンを押すと、現在選択されている模範解答画像を対象に、メインプロセス側で画像処理（例: OpenCV.jsを利用）を実行し、解答枠と思われる領域の候補を検出する。
検出された領域は、新しいエリアとして採点枠エディタに追加され、ユーザーはこれらの候補を確認、調整、削除できる。
（注意: 自動検出の精度は画像の状態に依存するため、あくまで補助機能として提供）
答案画像の読み込み:

UI: 「答案読み込み」専用画面。
操作:
スキャンされた答案画像ファイル（PNG, PDFなど）を、ドラッグ＆ドロップまたはファイル選択ダイアログで複数選択して読み込む。
読み込まれたファイルは、自動的にPNG形式に変換して保存される。
答案と生徒情報の一致:
読み込んだ答案ファイルと、事前に登録された生徒情報を照合するインターフェースを提供。
複数枚答案の対応: 複数枚の答案を含む試験の場合、ファイル名（例: 生徒名\_P1.png, 生徒名\_P2.png）や画像内容（氏名、学籍番号）から、生徒ごとに答案をまとめるか、ページごとにまとめるかを選択できるようなロジックとUIを提供。
ファイル名の並び替え: スキャンした画像ファイルが番号順でない場合でも、ファイル名を自然な順序（例: A1.png, A2.png, A10.png が A1, A2, A10 の順に）で並び替え、生徒ごとに整理できる機能。
欠席者対応:
読み込まれた答案リストから、簡単なクリック操作で欠席者の答案を「スキップ」または「非表示」に設定できる。
欠席者が後日受験した場合でも、後からその答案を読み込み、既存のプロジェクトに簡単に追加できる柔軟な機能。
一括採点（採点作業画面）:

UI: 「答案採点」画面。
操作:
採点対象の答案を選択。
採点順序の選択:
「左上から右に進んで次の行」
「右上から左に進んで次の行」
「左上から下に進んで次の列」
「右上から下に進んで次の列」
上記4つの順序から選択できる。
さらに、ドラッグして選択した答案群の一括採点もサポートする。
採点の種類と入力:
「正答」「部分点」「保留」「誤答」「無答」「未採点」の6種類の採点オプション。
部分点と保留の場合: 得点を設定できる入力欄を表示。
保留した答案: 採点済み答案書き出し時（PDF/Excel出力時）に警告が表示される。
キーボード操作の最適化:
全ての採点操作はキーボードで行えるように設計する（例: テンキーでの点数入力、特定のキーで正答/誤答など）。
採点パレットは、キーボードショートカットやUI要素で表示・非表示が直感的に切り替えられるようにする。
採点操作に使いやすいキー（例: テンキーの数字や矢印キー）がプリセットされているが、ユーザーが任意にキーバインドを設定できる機能を提供する。
採点時の表示：
解答枠の周りのボーダー表示: 基本的には、切り抜き表示された答案（設問領域）の周りを色付きのボーダーで囲んで、採点状況（例: 未採点、正答、誤答、保留）を区別する。これにより、採点記号が答案の内容を見えにくくする問題を回避する。
オーバーレイ表示の選択: 色弱のユーザーなど、色だけで認識するのが難しい人のために、採点記号（○×など）を答案画像にオーバーレイ表示できる機能をユーザーが選択できるようにする。この機能はデフォルトでオフに設定可能とする。
色のカスタマイズ: ボーダーやオーバーレイの色は、ユーザーが簡単に切り替えられるように設定画面で提供する。
答案の表示操作：
答案位置の移動: キーとのコンボ操作（例: Ctrl + ドラッグ）により、画面上の答案表示位置をドラッグして自由に移動できる。これにより、欄外に解答された答案内容もスムーズに確認できる。
全体表示/拡大表示の切り替え: クリック操作で、現在の解答枠の全て（元の答案全体）を表示したり、再度クリックで現在の解答枠に拡大表示したりする切り替え機能。
複数教員による協調採点（上記「4.2」参照）: 採点結果の比較表示、最終決定機能。
書き出し（集計・分析・出力）:

UI: 「採点結果」画面。
PDF書き出し:
採点記号を印字した採点済み答案ファイルをPDFとして書き出す機能。
並列処理: PDF生成処理には並列処理を組み込み、可能な限り最速で行う。
印字位置の柔軟性:
採点記号（○×、点数など）の印字位置は、解答枠の9点（四隅、各辺の中央、中心）を基準に柔軟に設定できる。
採点記号だけでなく、点数も同時に印字できる。
採点種類（正答、誤答など）によって、印字する記号や点数の表示・非表示を切り替えられる。
一括した設定の他に、設問ごとに特殊な印字位置を設定できる機能を提供。これにより、解答枠の大きさが異なる設問にも柔軟に対応。
Excel書き出し:
採点結果をExcelファイルとして書き出す機能。
exceljsを利用し、適切な関数（SUM, COUNTIFSなど）が組み込まれた、ユーザーが利活用しやすい形式で生成する。
各生徒の合計点、設問ごとの得点、正誤、コメントなどを整理して出力。
個人成績表:
PDF形式で、生徒一人につき1枚の個人成績表を一括して作成・出力できる。各生徒の成績概要や、設問ごとの正誤、コメントなどを記載。
